<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop - La Soigné</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet" />
  <style>
    body {
      padding-top: 70px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    .navbar {
      background: linear-gradient(90deg, #ffffff 0%, #ffffff 100%);
      border-bottom: 3px solid #000000;
    }
    .navbar-brand {
      color: #000000 !important;
      font-weight: bold;
      font-size: 1.3rem;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px #666666;
    }
    .navbar-nav .nav-link {
      color: #000000 !important;
      transition: color 0.3s ease;
    }
    .navbar-nav .nav-link:hover {
      color: #7e7e7e !important;
    }
    .dropdown-menu {
      background-color: #ffffff;
      border: 1px solid #000000;
    }
    .dropdown-item {
      color: #000000;
    }
    .dropdown-item:hover {
      background-color: #000000;
      color: #fffdfd;
    }
    .profile-img {
      object-fit: cover;
      border: 2px solid #ffffff;
      box-shadow: 0 0 5px rgba(126, 126, 126, 0.6);
    }
    .product-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .product-card img {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-md navbar-dark fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="/home.html">La Soigné</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto"></ul>

      <ul class="navbar-nav ms-auto align-items-center">
        <form class="d-flex me-3" action="/search.html" method="GET">
          <input class="form-control me-2" type="search" name="term" id="search-box" placeholder="Search..." autocomplete="off" />
          <button class="btn btn-hw" type="submit"><i class="bi bi-search"></i></button>
        </form>
        <li class="nav-item" id="login-link">
          <a class="nav-link btn btn-hw-outline mx-1" href="/login.html">LOGIN</a>
        </li>
        <li class="nav-item" id="register-link">
          <a class="nav-link btn btn-hw mx-1" href="/register.html">REGISTER</a>
        </li>
        <li class="nav-item dropdown d-none" id="user-dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="/uploads/default.jpg" alt="Profile Image" class="rounded-circle profile-img" width="40" height="40" />
            <span class="ms-2 text-uppercase" id="username">USER</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="/profile.html"><i class="bi bi-person-circle me-2"></i>PROFILE</a></li>
            <li><a class="dropdown-item" href="#" onclick="logoutUser()"><i class="bi bi-box-arrow-right me-2"></i>LOGOUT</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- SHOP PRODUCTS -->
<div class="container mt-4">
  <h2 class="mb-4">Shop Our Products</h2>
  <div class="row" id="shopProducts"></div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const API_URL = "http://localhost:4000/api/v1/products";

  function logoutUser() {
    sessionStorage.removeItem('token');
    sessionStorage.removeItem('userId');
    window.location.href = '/login.html';
  }

  function updateCartCount() {
    let cart = JSON.parse(sessionStorage.getItem("cart")) || [];
    let totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    $("#cart-count").text(totalItems);
  }

  function loadShopProducts() {
    $("#shopProducts").empty();
    $.get(API_URL, function(data) {
      if (!data || data.length === 0) {
        $("#shopProducts").append('<div class="col-12"><p>No products available.</p></div>');
        return;
      }
      data.forEach(product => {
        const firstImage = product.image.split(",")[0];
        $("#shopProducts").append(`
          <div class="col-md-3 mb-4">
            <div class="product-card">
              <img src="http://localhost:4000/images/${firstImage}" class="w-100" alt="${product.name}">
              <div class="card-body text-center">
                <h5 class="card-title">${product.name}</h5>
                <p class="card-text text-muted">₱${product.price}</p>
                <button class="btn btn-dark add-to-cart" 
                  data-id="${product.id}"
                  data-name="${product.name}"
                  data-price="${product.price}"
                  data-image="${firstImage}">
                  <i class="bi bi-cart-plus"></i> Add to Cart
                </button>
              </div>
            </div>
          </div>
        `);
      });
    });
  }

  $(document).ready(function() {
    loadShopProducts();
    updateCartCount();

    $(document).on("click", ".add-to-cart", function() {
      const token = sessionStorage.getItem("token");
      if (!token) {
        Swal.fire({
          icon: "warning",
          title: "Please login first",
          text: "You must be logged in to add items to the cart.",
          confirmButtonText: "Go to Login"
        }).then(() => {
          window.location.href = "/login.html";
        });
        return;
      }

      const product = {
        id: $(this).data("id"),
        name: $(this).data("name"),
        price: $(this).data("price"),
        image: $(this).data("image"),
        quantity: 1
      };

      let cart = JSON.parse(sessionStorage.getItem("cart")) || [];
      const existingProduct = cart.find(item => item.id === product.id);

      if (existingProduct) {
        existingProduct.quantity += 1;
      } else {
        cart.push(product);
      }

      sessionStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();

      Swal.fire({
        icon: "success",
        title: `${product.name} has been added to cart!`,
        showConfirmButton: false,
        timer: 1200
      });
    });

    // ✅ Autocomplete for product names
    $("#search-box").autocomplete({
      source: function(request, response) {
        $.ajax({
          url: API_URL,
          method: "GET",
          success: function(products) {
            const filtered = products
              .filter(p => p.name.toLowerCase().includes(request.term.toLowerCase()))
              .map(p => ({ label: p.name, value: p.name }));
            response(filtered);
          }
        });
      },
      minLength: 1
    });
  });
</script>
</body>
</html>
