<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body class="bg-light">
  <div id="header"></div>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8 bg-white p-4 rounded shadow-sm">
        <div class="row">
          
          <!-- ✅ LEFT SIDE: PROFILE IMAGE + CURRENT INFO -->
          <div class="col-md-4 text-center">
            <img id="profileImagePreview" src="https://via.placeholder.com/150" class="rounded-circle border mb-3" style="width:130px;height:130px;object-fit:cover;" alt="Profile" />
            <input type="file" class="form-control-file mb-3" name="image" id="image" accept="image/*" />

            <!-- ✅ CURRENT INFO -->
            <div class="text-left bg-light p-2 rounded border">
              <h6 class="text-secondary">Current Information</h6>
              <p class="mb-1"><strong>Name:</strong> <span id="infoName">-</span></p>
              <p class="mb-1"><strong>Address:</strong> <span id="infoAddress">-</span></p>
              <p class="mb-1"><strong>Town:</strong> <span id="infoTown">-</span></p>
              <p class="mb-1"><strong>Phone:</strong> <span id="infoPhone">-</span></p>
            </div>
          </div>

          <!-- ✅ RIGHT SIDE: PROFILE FORM -->
          <div class="col-md-8">
            <h4 class="mb-3 text-primary">My Profile</h4>
            <form id="profileForm" enctype="multipart/form-data">
              <input type="hidden" name="userId" id="userId" />

              <div class="form-group">
                <label for="title">Title</label>
                <select class="form-control form-control-sm w-75" name="title" id="title">
                  <option value="">Select Title</option>
                  <option value="Mr.">Mr.</option>
                  <option value="Ms.">Ms.</option>
                  <option value="Mrs.">Mrs.</option>
                </select>
              </div>

              <div class="form-group">
                <label for="fname">First Name</label>
                <input type="text" class="form-control form-control-sm w-75" name="fname" id="fname" placeholder="First Name" required />
              </div>

              <div class="form-group">
                <label for="lname">Last Name</label>
                <input type="text" class="form-control form-control-sm w-75" name="lname" id="lname" placeholder="Last Name" required />
              </div>

              <div class="form-group">
                <label for="addressline">Address</label>
                <input type="text" class="form-control form-control-sm w-75" name="addressline" id="addressline" placeholder="Complete Address" />
              </div>

              <div class="form-group">
                <label for="town">Town</label>
                <input type="text" class="form-control form-control-sm w-75" name="town" id="town" placeholder="Town" />
              </div>

              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" class="form-control form-control-sm w-75" name="phone" id="phone" placeholder="Phone" />
              </div>

              <div class="d-flex justify-content-between align-items-center">
                <p id="profileMsg" class="mb-0"></p>
                <button type="submit" class="btn btn-success btn-sm">Save Profile</button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');

      if (!token || !userId) {
        alert("You must be logged in first!");
        window.location.href = '/login.html';
        return;
      }

      $('#userId').val(userId);

      $('#header').load('/header.html', function () {
        $('#login-link, #register-link').addClass('d-none');
        $('#user-dropdown').removeClass('d-none');

        $.ajax({
          url: `/api/v1/customers/${userId}`,
          method: 'GET',
          success: function (res) {
            if (res.success && res.data) {
              const data = res.data;
              const fullName = `${data.fname || ''} ${data.lname || ''}`.trim();
              $('#username').text(fullName || 'USER');
              if (data.image_path) {
                $('.profile-img').attr('src', `/${data.image_path}`);
              }
            }
          }
        });

        fetchProfileData(userId);
      });

      function fetchProfileData(userId) {
        $.ajax({
          url: `/api/v1/customers/${userId}`,
          method: 'GET',
          success: function (res) {
            if (res.success && res.data) {
              const d = res.data;
              $('#title').val(d.title || '');
              $('#fname').val(d.fname || '');
              $('#lname').val(d.lname || '');
              $('#addressline').val(d.addressline || '');
              $('#town').val(d.town || '');
              $('#phone').val(d.phone || '');
              if (d.image_path) {
                $('#profileImagePreview').attr('src', `/${d.image_path}`);
              }

              // ✅ Update current info (LEFT SIDE)
              $('#infoName').text(`${d.title || ''} ${d.fname || ''} ${d.lname || ''}`.trim() || '-');
              $('#infoAddress').text(d.addressline || '-');
              $('#infoTown').text(d.town || '-');
              $('#infoPhone').text(d.phone || '-');
            }
          },
          error: function () {
            console.warn('No profile found.');
          }
        });
      }

      $('#image').on('change', function () {
        const file = this.files[0];
        if (file) {
          $('#profileImagePreview').attr('src', URL.createObjectURL(file));
        }
      });

      $('#profileForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.set('userId', userId);

        $.ajax({
          url: '/api/v1/update-profile',
          method: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          headers: { Authorization: `Bearer ${token}` },
          success: function () {
            $('#profileMsg').text('✅ Profile saved!').css('color', 'green');
            fetchProfileData(userId);
          },
          error: function (err) {
            $('#profileMsg').text('❌ Failed to save.').css('color', 'red');
            console.error(err);
          }
        });
      });
    });
  </script>
</body>
</html>
