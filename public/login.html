<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Login</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.css"
    integrity="sha512-fjO3Vy3QodX9c6G9AUmr6WuIaEPdGRxBjD7gjatG5gGylzYyrEq3U0q+smkG6CwIY0L8XALRFHh4KPHig0Q1ug=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
    integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"
    integrity="sha512-LGHBR+kJ5jZSIzhhdfytPoEHzgaYuTRifq9g5l6ja6/k9NAOsAi5dQh4zQF6JIRB8cAYxTRedERUF+97/KuivQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
  <div id="loginBody"></div>

  <form id="loginForm" style="max-width: 400px; margin: auto">
    <h2>Login</h2>

    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" class="form-control" id="email" name="email" required />
    </div>

    <div class="form-group">
      <label for="password">Password:</label>
      <input type="password" class="form-control" id="password" name="password" required />
    </div>

    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
      Login
    </button>
  </form>

  <script>
    // Define your base URL
    const url = 'http://localhost:4000/';

    // Validation functions
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePassword(password) {
      return password.length >= 8;
    }

    function showError(inputId, message) {
      const input = $('#' + inputId);
      const errorDiv = $('<div class="text-danger small mt-1">').text(message);
      input.addClass('is-invalid');
      input.after(errorDiv);
    }

    function clearErrors() {
      $('.is-invalid').removeClass('is-invalid');
      $('.text-danger').remove();
    }

    $(document).ready(function () {
      // ✅ Check if already logged in
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role');
      if (token && role) {
        if (role === 'Admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'home.html';
        }
      }

      // Login handler
      $("#loginBtn").on('click', function (e) {
        e.preventDefault();
        clearErrors();

        const email = $("#email").val().trim();
        const password = $("#password").val().trim();

        // Validation
        if (!email) {
          showError('email', 'Email is required');
          return;
        }

        if (!validateEmail(email)) {
          showError('email', 'Please enter a valid email');
          return;
        }

        if (!password) {
          showError('password', 'Password is required');
          return;
        }

        if (!validatePassword(password)) {
          showError('password', 'Password must be at least 8 characters');
          return;
        }

        const user = { email, password };

        $.ajax({
          method: "POST",
          url: url + "api/v1/login",
          data: JSON.stringify(user),
          contentType: 'application/json',
          dataType: "json",
          success: function (response) {
            if (response.token && response.user) {
              // ✅ Store token and role
              localStorage.setItem('token', response.token);
              localStorage.setItem('userId', response.user.id);
              localStorage.setItem('role', response.user.role);

              Swal.fire({
                icon: 'success',
                title: 'Login Successful',
                showConfirmButton: false,
                timer: 1500
              }).then(() => {
                // ✅ Redirect by role
                if (response.user.role === 'Admin') {
                  window.location.href = 'admin.html';
                } else {
                  window.location.href = 'home.html';  // ✅ Changed from profile.html
                }
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Login Failed',
                text: response.message || 'Invalid server response'
              });
            }
          },
          error: function (xhr) {
            let errorMsg = 'Login failed';
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMsg = xhr.responseJSON.message;
            }
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: errorMsg
            });
          }
        });
      });

      // Email validation on blur
      $("#email").on('blur', function () {
        const email = $(this).val().trim();
        if (email && !validateEmail(email)) {
          showError('email', 'Please enter a valid email');
        }
      });

      // Password validation on blur
      $("#password").on('blur', function () {
        const password = $(this).val().trim();
        if (password && !validatePassword(password)) {
          showError('password', 'Password must be at least 8 characters');
        }
      });
    });
  </script>
</body>

</html>