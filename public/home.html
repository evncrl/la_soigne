<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Home</title>

  <!-- Bootstrap & CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.css">
  <link rel="stylesheet" href="css/style.css" />

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"></script>

  <!-- Autocomplete -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
</head>

<body>
  <!-- ✅ Modal for Product Details -->
  <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body" id="productDetailsModalBody">
          <!-- dynamic content -->
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Header -->
  <div id="header"></div>

  <!-- ✅ Product List -->
  <div class="container mt-4">
    <h1 class="mb-4">La Soigne Products</h1>
    <div class="row" id="items">
      <!-- Products will appear here -->
    </div>
  </div>

  <script>
    const url = 'http://localhost:4000/';
    let userId;

    let offset = 0;
    const limit = 9;
    let isLoading = false;
    let allLoaded = false;

    $(document).ready(function () {
      const token = localStorage.getItem("token");
      userId = localStorage.getItem("userId");

      if (!token || !userId) {
        Swal.fire({
          icon: "warning",
          text: "You must be logged in first!",
          showConfirmButton: true,
        }).then(() => {
          window.location.href = "/login.html";
        });
        return;
      }

      // ✅ Load header
      $("#header").load("/header.html", function () {
        const headerHeight = $("#header").outerHeight() || 60;
        $("body").css("padding-top", headerHeight + 20 + "px");

        $("#login-link, #register-link").addClass("d-none");
        $("#user-dropdown").removeClass("d-none");

        $.ajax({
          url: `/api/v1/customers/${userId}`,
          method: "GET",
          success: function (res) {
            if (res.success && res.data) {
              const data = res.data;
              const fullName = `${data.fname || ""} ${data.lname || ""}`.trim();
              $("#username").text(fullName || "USER");
              if (data.image_path) {
                $(".profile-img").attr("src", `/${data.image_path}`);
              }
            }
          }
        });
      });

      // ✅ Load products
      loadProducts();
    });

    function loadProducts() {
      const API_URL = url + "api/v1/products";

      function fetchMoreProducts() {
        if (isLoading || allLoaded) return;
        isLoading = true;
        $("#loadingProducts").show();

        $.get(`${API_URL}?offset=${offset}&limit=${limit}`, function (products) {
          if (!products || products.length === 0) {
            allLoaded = true;
            $("#endOfProducts").show();
            return;
          }

          products.forEach((product) => {
            const images = product.image ? product.image.split(",").map(img => img.trim()) : ["placeholder.png"];
            let carouselInner = "";
            images.forEach((img, index) => {
              carouselInner += `
            <div class="carousel-item ${index === 0 ? "active" : ""}">
              <img src="${url}images/${img}" class="d-block w-100" alt="${product.name}">
            </div>`;
            });

            const carouselId = `carousel${product.id}`;
            const carouselHTML = `
          <div id="${carouselId}" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner">${carouselInner}</div>
            ${images.length > 1 ? `
              <a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              </a>
              <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
              </a>` : ""}
          </div>`;

            $("#items").append(`
          <div class="col-md-4 mb-4">
            <div class="card product-card shadow-sm">
              ${carouselHTML}
              <div class="card-body">
                <h5 class="card-title">${product.name}</h5>
                <p class="card-text text-muted">${product.description}</p>
                <p class="font-weight-bold text-primary">₱${product.price}</p>
                <button class="btn btn-info show-details"
                  data-id="${product.id}"
                  data-name="${product.name}"
                  data-description="${product.description}"
                  data-price="${product.price}"
                  data-stock="${product.stock}"
                  data-image='${JSON.stringify(images)}'>
                  Details
                </button>
                <button class="btn btn-primary mt-2"
                  onclick="addToCart({id: ${product.id}, name: '${product.name}', price: ${product.price}, image: '${product.image}'})">
                  Add to Cart
                </button>
              </div>
            </div>
          </div>`);
          });

          offset += limit;
        }).fail(function () {
          console.error("Failed to fetch products.");
        }).always(function () {
          isLoading = false;
          $("#loadingProducts").hide();
        });
      }

      // ✅ Only run once
      fetchMoreProducts();

      if (!$("#loadingProducts").length) {
        $("#items").after(`
      <div id="loadingProducts" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
      </div>
      <div id="endOfProducts" class="text-center text-muted my-3" style="display:none;">
        <small>No more products to load.</small>
      </div>
    `);
      }
    }

    // ✅ Setup infinite scroll to only call fetchMoreProducts()
    $(window).off("scroll").on("scroll", function () {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
        fetchMoreProducts();  // not loadProducts()
      }
    });




    function addToCart(product) {
      const cartKey = `cart_${userId}`;
      let cart = JSON.parse(localStorage.getItem(cartKey)) || [];

      const existingItem = cart.find(item => item.id === product.id);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }

      localStorage.setItem(cartKey, JSON.stringify(cart));
      Swal.fire("✅ Added!", "Product added to cart!", "success");
    }

    // ✅ PRODUCT DETAILS MODAL + REVIEWS
    $(document).on('click', '.show-details', function () {
      const id = $(this).data('id');
      const name = $(this).data('name');
      const description = $(this).data('description');
      const price = $(this).data('price');
      const stock = $(this).data('stock');
      const images = JSON.parse($(this).attr('data-image'));

      let modalCarouselItems = '';
      $.each(images, function (index, img) {
        modalCarouselItems += `
          <div class="carousel-item ${index === 0 ? 'active' : ''}">
            <img src="${url}images/${img}" class="d-block w-100" style="max-height:200px;">
          </div>`;
      });

      $('#productDetailsModalLabel').text(name);
      $('#productDetailsModalBody').html(`
        <div id="modalCarousel${id}" class="carousel slide mb-3" data-ride="carousel">
          <div class="carousel-inner">
            ${modalCarouselItems}
          </div>
          <a class="carousel-control-prev" href="#modalCarousel${id}" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </a>
          <a class="carousel-control-next" href="#modalCarousel${id}" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </a>
        </div>
        <p><strong>Description:</strong> ${description}</p>
        <p><strong>Price:</strong> ₱${price}</p>
        <input type="hidden" id="detailsItemId" value="${id}">
        <hr>
        <h6>Product Reviews</h6>
        <div id="product-reviews"><p>Loading reviews...</p></div>
      `);

      $('#productDetailsModal').modal('show');

      $.get(`${url}api/v1/reviews/${id}`, function (res) {
        if (res.success && res.data.length > 0) {
          const reviewsHTML = res.data.map(r => `
            <div class="border p-2 mb-2 rounded bg-light">
              <strong>${r.fname} ${r.lname}</strong>
              <div>⭐ ${r.rating}/5</div>
              <small class="text-muted">${new Date(r.created_at).toLocaleString()}</small>
              <p class="mb-0">${r.review_text}</p>
            </div>
          `).join('');
          $('#product-reviews').html(reviewsHTML);
        } else {
          $('#product-reviews').html('<p class="text-muted">No reviews yet.</p>');
        }
      }).fail(() => {
        $('#product-reviews').html('<p class="text-danger">Failed to load reviews.</p>');
      });
    });

    // ✅ ADD TO CART FROM MODAL BUTTON
    $(document).on('click', '#detailsAddToCart', function () {
      const id = $("#detailsItemId").val();
      const name = $("#productDetailsModalLabel").text();
      const price = parseFloat($("#productDetailsModalBody").find("strong").last().text().replace(/[^\d.]/g, ''));
      const image = $("#productDetailsModalBody img").attr("src");

      const product = {
        id: parseInt(id),
        name,
        price,
        image
      };

      addToCart(product);
      $('#productDetailsModal').modal('hide');
    });
  </script>
</body>

</html>