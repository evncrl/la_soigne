<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.css">
  <link rel="stylesheet" href="css/style.css" /> <!-- ✅ external CSS -->

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.16.1/sweetalert2.min.js"></script>

  <title>Home</title>
</head>

<body>
  <!-- ✅ Header will be loaded dynamically -->
  <div id="header"></div>

  <div class="container mt-4">
    <h1 class="mb-4">La Soigne Products</h1>
    <div class="row" id="items">
      <!-- ✅ Products will be appended here -->
    </div>
  </div>

  <script>
    let userId;

    $(document).ready(function () {
      const token = localStorage.getItem("token");
      userId = localStorage.getItem("userId");

      if (!token || !userId) {
        Swal.fire({
          icon: "warning",
          text: "You must be logged in first!",
          showConfirmButton: true,
        }).then(() => {
          window.location.href = "/login.html";
        });
        return;
      }

      // ✅ Load header
      $("#header").load("/header.html", function () {
        const headerHeight = $("#header").outerHeight() || 60;
        $("body").css("padding-top", headerHeight + 20 + "px");

        $("#login-link, #register-link").addClass("d-none");
        $("#user-dropdown").removeClass("d-none");

        $.ajax({
          url: `/api/v1/customers/${userId}`,
          method: "GET",
          success: function (res) {
            if (res.success && res.data) {
              const data = res.data;
              const fullName = `${data.fname || ""} ${data.lname || ""}`.trim();
              $("#username").text(fullName || "USER");
              if (data.image_path) {
                $(".profile-img").attr("src", `/${data.image_path}`);
              }
            }
          }
        });
      });

      // ✅ Load products
      loadProducts();
    });

    function loadProducts() {
      const API_URL = "http://localhost:4000/api/v1/products";
      $("#items").empty();

      $.get(API_URL, function (products) {
        if (!products || products.length === 0) {
          $("#items").html(
            '<div class="col-12 text-center"><p>No products available.</p></div>'
          );
          return;
        }

        products.forEach((product) => {
          const images = product.image
            ? product.image.split(",").map(img => img.trim())
            : ["placeholder.png"];

          let carouselInner = "";
          images.forEach((img, index) => {
            carouselInner += `
              <div class="carousel-item ${index === 0 ? "active" : ""}">
                <img src="http://localhost:4000/images/${img}" class="d-block w-100" alt="${product.name}">
              </div>`;
          });

          const carouselId = `carousel${product.id}`;

          const carouselHTML = `
            <div id="${carouselId}" class="carousel slide" data-ride="carousel">
              <div class="carousel-inner">
                ${carouselInner}
              </div>
              ${images.length > 1
              ? `<a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  </a>
                  <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  </a>` : ""}
            </div>`;

          $("#items").append(`
            <div class="col-md-4 mb-4">
              <div class="card product-card shadow-sm">
                ${carouselHTML}
                <div class="card-body">
                  <h5 class="card-title">${product.name}</h5>
                  <p class="card-text text-muted">${product.description}</p>
                  <p class="font-weight-bold text-primary">₱${product.price}</p>
                  <button class="btn btn-primary"
                    onclick="addToCart({id: ${product.id}, name: '${product.name}', price: ${product.price}, image: '${product.image}'})">
                    Add to Cart
                  </button>
                </div>
              </div>
            </div>
          `);
        });
      });
    }

    function addToCart(product) {
      const userId = localStorage.getItem("userId");
      const cartKey = `cart_${userId}`;
      let cart = JSON.parse(localStorage.getItem(cartKey)) || [];

      const existingItem = cart.find(item => item.id === product.id);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: product.id,      // ✅ use id
          name: product.name,
          price: product.price,
          image: product.image,
          quantity: 1
        });
      }

      localStorage.setItem(cartKey, JSON.stringify(cart));
      Swal.fire("✅ Added!", "Product added to cart!", "success");
    }

  </script>
</body>

</html>