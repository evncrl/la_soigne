<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>All Products - La Soigne</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light p-4">

  <div class="container">
    <h2 class="mb-4">All Products</h2>

    <!-- ✅ PRODUCTS TABLE -->
    <table class="table table-bordered table-striped mt-3">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Price</th>
          <th>Category</th>
          <th>Image</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="productsBody">
        <!-- Products will load here -->
      </tbody>
    </table>

    <!-- ✅ Add Product Button -->
    <button class="btn btn-success mt-3" id="openAddModal" data-toggle="modal" data-target="#productModal">
      + Add Product
    </button>
  </div>

  <!-- ✅ PRODUCT MODAL -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="productForm" enctype="multipart/form-data">
            <input type="hidden" id="productId" />

            <div class="form-group">
              <label for="name">Product Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" />
              <div class="text-danger small mt-1" id="nameError"></div>
            </div>

            <div class="form-group">
              <label for="description">Description <span class="text-danger">*</span></label>
              <textarea class="form-control" id="description" rows="3"></textarea>
              <div class="text-danger small mt-1" id="descriptionError"></div>
            </div>

            <div class="form-group">
              <label for="price">Price (₱) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="price" />
              <div class="text-danger small mt-1" id="priceError"></div>
            </div>

            <div class="form-group">
              <label for="category">Category <span class="text-danger">*</span></label>
              <select class="form-control" id="category">
                <option value="">Select a category</option>
                <option value="Shirt">Shirt</option>
                <option value="Bottoms">Bottoms</option>
                <option value="Accessories">Accessories</option>
              </select>
              <div class="text-danger small mt-1" id="categoryError"></div>
            </div>

            <div class="form-group">
              <label for="images">Upload Product Images <span class="text-danger">*</span></label>
              <input type="file" class="form-control" id="images" name="images" multiple />
              <div class="text-danger small mt-1" id="imagesError"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="saveBtn">Save Product</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:4000/api/v1/products';
    let isEditMode = false;

    function validateFields() {
      let valid = true;
      function showError(id, message) {
        $(`#${id}Error`).text(message);
        if (message) valid = false;
      }
      showError('name', $('#name').val().trim().length < 2 ? 'Minimum 2 characters required' : '');
      showError('description', $('#description').val().trim().length < 5 ? 'Minimum 5 characters required' : '');
      showError('price', ($('#price').val() <= 0 || isNaN($('#price').val())) ? 'Enter a valid price' : '');
      showError('category', $('#category').val() === '' ? 'Please select a category' : '');
      if (!isEditMode) {
        showError('images', $('#images')[0].files.length === 0 ? 'At least one image is required' : '');
      } else {
        $('#imagesError').text('');
      }
      return valid;
    }

    function loadProducts() {
      $('#productsBody').empty();
      $.get(API_URL, function (data) {
        if (!data || data.length === 0) {
          $('#productsBody').append('<tr><td colspan="8">No products found.</td></tr>');
          return;
        }
        data.forEach(product => {
          $('#productsBody').append(`
            <tr>
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${product.description}</td>
              <td>₱${product.price}</td>
              <td>${product.category}</td>
              <td>
                ${product.image
                  .split(',')
                  .map(img => `<img src="http://localhost:4000/images/${img}" width="50" class="mr-1">`)
                  .join('')}
              </td>
              <td>${new Date(product.created_at).toLocaleString()}</td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="editProduct(${product.id}, '${product.name}', '${product.description}', '${product.price}', '${product.category}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Delete</button>
              </td>
            </tr>
          `);
        });
      });
    }

    $('#openAddModal').on('click', function () {
      isEditMode = false;
      $('#productModalLabel').text('Add New Product');
      $('#saveBtn').text('Save Product').removeClass('btn-primary').addClass('btn-success');
      $('#productForm')[0].reset();
      $('#productId').val('');
    });

    $('#saveBtn').on('click', function () {
      if (!validateFields()) {
        Swal.fire({ icon: 'warning', title: 'Please correct all fields before submitting.' });
        return;
      }

      const formData = new FormData();
      formData.append('name', $('#name').val().trim());
      formData.append('description', $('#description').val().trim());
      formData.append('price', $('#price').val().trim());
      formData.append('category', $('#category').val().trim());
      const files = $('#images')[0].files;
      for (let i = 0; i < files.length; i++) {
        formData.append('images', files[i]);
      }

      const productId = $('#productId').val();
      const method = isEditMode ? 'PUT' : 'POST';
      const url = isEditMode ? `${API_URL}/${productId}` : API_URL;

      $.ajax({
        method: method,
        url: url,
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
          Swal.fire({
            icon: 'success',
            title: isEditMode ? 'Product Updated' : 'Product Created',
            text: res.message || 'Success!'
          }).then(() => {
            $('#productForm')[0].reset();
            $('#productModal').modal('hide');
            loadProducts();
          });
        },
        error: function (xhr) {
          Swal.fire({ icon: 'error', title: 'Error', text: xhr.responseJSON?.error || 'Something went wrong.' });
        }
      });
    });

    function editProduct(id, name, description, price, category) {
      isEditMode = true;
      $('#productModalLabel').text('Edit Product');
      $('#saveBtn').text('Update Product').removeClass('btn-success').addClass('btn-primary');
      $('#productId').val(id);
      $('#name').val(name);
      $('#description').val(description);
      $('#price').val(price);
      $('#category').val(category);
      $('#images').val('');
      $('#productModal').modal('show');
    }

    function deleteProduct(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: 'This product will be deleted permanently!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            method: 'DELETE',
            url: `${API_URL}/${id}`,
            success: function () {
              Swal.fire('Deleted!', 'Product has been deleted.', 'success');
              loadProducts();
            },
            error: function () {
              Swal.fire('Error', 'Failed to delete product.', 'error');
            }
          });
        }
      });
    }

    $(document).ready(function () {
      loadProducts();
    });
  </script>
</body>

</html>